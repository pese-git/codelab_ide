# Панель reasoning/плана AI-агента — пример UI и рекомендации

## Цель
Показывать в IDE, как AI-агент (или цепочка агентов) строит план, пошагово выполняет и отслеживает действия для любого запроса пользователя (например: рефакторинг кода, написание тестов, генерация пояснений).

## Типовой интерфейс reasoning/plan панели

### 1. **Общий план (многошаговое reasoning)**
Показывает последовательность крупных шагов, которые планирует агент для текущей задачи.

| Шаг          | Описание                | Статус           |
|--------------|------------------------|------------------|
| 1            | Анализировать main.py  | ГОТОВО (DONE)    |
| 2            | Рефакторинг кода       | В РАБОТЕ         |
| 3            | Генерация тестов       | ОЖИДАНИЕ/БЛОКИРОВКА|

_Вывод: “Планирую...” → шаги наполняются по мере получения plan_update/plan_progress с сервера._


### 2. **Детали текущего шага**
Показывает прогресс по текущему шагу: инструменты, действия агента, логи.

---
**Шаг: Рефакторинг кода**  
_Статус: В РАБОТЕ_  

- [read_file] (готово)
- [refactor_code] (в работе)

Окно логов:
```
read_file: OK
refactor_code: применение изменений...
```
---

### 3. **Цепочка агентов (для multi-agent)**
Графическое (или табличное) представление участвующих в сессии агентов и их статусов:

| Агент      | Роль         | Статус   |
|------------|--------------|----------|
| Рефактор   | Кодинг       | ГОТОВО   |
| Тестировщик| Ген. тестов  | В РАБОТЕ |
| Документатор| Документация| ЖДЁТ     |

Если поддерживается переключение между агентами, сделайте вкладки или отдельные секции по агенту.


### 4. **Встроенная обратная связь/объяснения**
- Для каждого шага плана или инструмента показывайте промежуточные пояснения, логи.
- Ошибки, предупреждения, запросы дополнительного ввода отображайте сразу рядом с соответствующим шагом.

---

## Диалог Human-in-the-Loop (HITL) в reasoning-панели

### Зачем нужен HITL UI?
Когда агент предлагает действие, для которого требуется ручное подтверждение (например, запись файла, `run` скриптов, SQL), reasoning/план агентом приостанавливается до решения пользователя. В панели плана появляется отдельный блок ожидания HITL-ответа.

### Что отображать в UI HITL?
- Превью действия (название инструмента, параметры, предполагаемый эффект)
- Текстовое описание потенциального риска
- Кнопки: 
  - "Разрешить (Approve)"
  - "Изменить (Edit)" (открывает редактор параметров действия)
  - "Отклонить (Reject)" (с пояснением причины)
- Индикатор статуса ожидания (“ожидание решения пользователя”)
- Ссылка/лог на историю одобренных/отклонённых действий (для аудита)

### Пример UI логики (псевдо)
```dart
PlanPanelStep(
  step: ..., // tool_call с requires_approval
  hitlPending: true,
  onApprove: () => sendHitlResponse("approve"),
  onEdit: (newArgs) => sendHitlResponse("edit", editedArguments: newArgs),
  onReject: (reason) => sendHitlResponse("reject", feedback: reason),
)
```

### UX: куда внедрять HITL?
- В общий план — во второстепенных шагах появляется метка “⋕ Требует подтверждения”
- В деталях шага — динамический диалог с формой редактирования параметров, подтверждением действий, объяснением возможных последствий
- Все решения пользователя фиксируются в истории reasoning

### Пользовательский флоу
- Приходит tool_call с requires_approval
- Reasoning панель подсвечивает HITL-степ, блокирует последующее выполнение
- После выбора действия отправляется hitl_response и reasoning не идёт дальше без решения

---

## Идеи по реализации UI
- Используйте **боковую панель** или нижнее окно, которое обновляется в реальном времени по мере поступления plan/step/progress.
- Дайте возможность **сворачивать/разворачивать** детали по шагам.
- Используйте **цветовые/статусные метки** ([ожидание, в работе, завершено, ошибка...]).
- **По клику на шаг** показывайте связанный код-дифф или подробный лог.
- Если поддерживается много агентов, выводите обобщённый статус цепочки; по возможности — реализуйте «пауза reasoning» и ручное вмешательство пользователя.


## Пример (псевдо-на-Fluent UI/Dart)

```dart
Expanded(
  child: PlanPanel(
    planSteps: [ ... ], // из plan_update
    currentStep: ...,  // показывать логи, вызовы
    agentChain: [ ... ], // опционально, если мультииагент
    onStepSelect: (stepId) { /* подробнее по шагу */ },
  )
)
```

## Пользовательский опыт
- Пользователь всегда видит: «Что агент делает СЕЙЧАС?», «Почему выбран этот шаг?», «Что дальше?»
- Все ошибки и отклонения видны в контексте reasoning/planning.

## См. также
- [agent_extended_protocol.md](./agent_extended_protocol.md)
